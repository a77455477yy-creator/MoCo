<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>åœ°ç†ä½ç½®èˆ‡æ„Ÿæ¸¬å™¨ï¼ˆæ¬Šé™æª¢æŸ¥ç‰ˆï¼‰</title>
</head>
<body>

    <h1>ğŸŒ åœ°ç†ä½ç½®è³‡è¨Š</h1>
    <p>æœå‹™ç‹€æ…‹: <span id="service-status">æ­£åœ¨æª¢æŸ¥æœå‹™æ”¯æ´...</span></p>
    <p>åœ°ç†ä½ç½®æ¬Šé™ç‹€æ…‹: <span id="geo-permission-status">æ­£åœ¨æª¢æŸ¥æ¬Šé™...</span></p>
    
    <hr>
    
    <p>ç·¯åº¦ (Latitude): <span id="latitude-value">ç­‰å¾…è®€å–...</span></p>
    <p>ç¶“åº¦ (Longitude): <span id="longitude-value">ç­‰å¾…è®€å–...</span></p>

    <hr>

    <h1>ğŸƒ åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ (DeviceMotionEvent)</h1>
    <p id="motion-status">æ­£åœ¨æª¢æŸ¥æ”¯æ´...</p>
    <p>æ„Ÿæ¸¬å™¨æ¬Šé™æª¢æŸ¥çµæœ: <span id="sensor-permission-result">æœªæª¢æŸ¥</span></p>
    
    <p>X è»¸åŠ é€Ÿåº¦ (Gravity): <span id="accel-x">0</span> g/ç§’Â²</p>
    <p>Y è»¸åŠ é€Ÿåº¦ (Gravity): <span id="accel-y">0</span> g/ç§’Â²</p>
    <p>Z è»¸åŠ é€Ÿåº¦ (Gravity): <span id="accel-z">0</span> g/ç§’Â²</p>

    <script>
        // --- HTML å…ƒç´ ç²å– ---
        const serviceStatusElement = document.getElementById('service-status');
        const geoPermissionStatusElement = document.getElementById('geo-permission-status');
        const latElement = document.getElementById('latitude-value');
        const lonElement = document.getElementById('longitude-value');
        const motionStatusElement = document.getElementById('motion-status');
        const sensorPermissionResultElement = document.getElementById('sensor-permission-result');
        const accelXElement = document.getElementById('accel-x');
        const accelYElement = document.getElementById('accel-y');
        const accelZElement = document.getElementById('accel-z');

        // --- æ‚¨æä¾›çš„æ„Ÿæ¸¬å™¨æ¬Šé™è«‹æ±‚å‡½æ•¸ ---
        /**
         * è«‹æ±‚æ„Ÿæ¸¬å™¨æ¬Šé™ï¼ˆéƒ¨åˆ†ç€è¦½å™¨éœ€è¦ï¼‰
         */
        async function requestSensorPermissions() {
            if (!navigator.permissions) {
                sensorPermissionResultElement.textContent = "âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´ navigator.permissions APIã€‚";
                return;
            }

            try {
                // æª¢æŸ¥åŠ é€Ÿåº¦è¨ˆæ¬Šé™
                const accelPerm = await navigator.permissions.query({ name: 'accelerometer' });
                // æª¢æŸ¥é™€èºå„€æ¬Šé™
                const gyroPerm = await navigator.permissions.query({ name: 'gyroscope' });
                
                let resultText = `åŠ é€Ÿåº¦è¨ˆ: ${accelPerm.state} | é™€èºå„€: ${gyroPerm.state}`;

                if (accelPerm.state === 'denied' || gyroPerm.state === 'denied') {
                    resultText = "âŒ " + resultText + " (æ„Ÿæ¸¬å™¨æ¬Šé™è¢«æ‹’çµ•ï¼Œå¯èƒ½ç„¡æ³•é‹ä½œ)";
                } else if (accelPerm.state === 'prompt' || gyroPerm.state === 'prompt') {
                     resultText = "â— " + resultText + " (éœ€è¦æ“ä½œä¾†è§¸ç™¼æˆæ¬Š)";
                } else {
                     resultText = "âœ… " + resultText + " (æ„Ÿæ¸¬å™¨æ¬Šé™æª¢æŸ¥é€šé)";
                }

                sensorPermissionResultElement.textContent = resultText;
            } catch (error) {
                sensorPermissionResultElement.textContent = `æ¬Šé™è«‹æ±‚å¯èƒ½ä¸è¢«æ”¯æ´: ${error.message}`;
                console.error("æ¬Šé™è«‹æ±‚éŒ¯èª¤:", error);
            }
        }

        // --- åœ°ç†ä½ç½®ç›¸é—œå‡½æ•¸ ---
        function handlePosition(position) {
            const coords = position.coords;
            latElement.textContent = coords.latitude;
            lonElement.textContent = coords.longitude;
            serviceStatusElement.textContent = "âœ… ä½ç½®è®€å–æˆåŠŸï¼";
        }

        function handlePositionError(error) {
            let errorMessage = "ä½ç½®è®€å–å¤±æ•—ã€‚";
            if (error.code === error.PERMISSION_DENIED) {
                errorMessage += "ä½¿ç”¨è€…æ‹’çµ•äº†è«‹æ±‚ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚";
            } else {
                errorMessage += `ç™¼ç”ŸéŒ¯èª¤ (ä»£ç¢¼: ${error.code})ã€‚`;
            }
            serviceStatusElement.textContent = `âŒ ${errorMessage}`;
            latElement.textContent = "ç„¡æ³•å–å¾—";
            lonElement.textContent = "ç„¡æ³•å–å¾—";
        }

        async function checkGeoPermissionStatus() {
            if (!navigator.permissions) {
                geoPermissionStatusElement.textContent = "âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´æ¬Šé™æª¢æŸ¥ APIã€‚";
                return;
            }

            try {
                const permission = await navigator.permissions.query({ name: 'geolocation' });
                geoPermissionStatusElement.textContent = `ç‹€æ…‹: ${permission.state}`;
                if (permission.state === 'denied') {
                    geoPermissionStatusElement.textContent += " (âŒ å·²æ‹’çµ•ï¼)";
                }
            } catch (e) {
                geoPermissionStatusElement.textContent = "âš ï¸ æ¬Šé™æª¢æŸ¥å¤±æ•—ã€‚";
            }
        }

        function getGeolocation() {
            if ("geolocation" in navigator) {
                serviceStatusElement.textContent = "ğŸ‘ åœ°ç†ä½ç½®æœå‹™å¯ç”¨ï¼Œæ­£åœ¨è«‹æ±‚ä½ç½®...";
                checkGeoPermissionStatus();

                navigator.geolocation.getCurrentPosition(
                    handlePosition,  
                    handlePositionError 
                );
            } else {
                serviceStatusElement.textContent = "ğŸ‘ åœ°ç†ä½ç½®æœå‹™ä¸å¯ç”¨ã€‚";
                latElement.textContent = "ä¸æ”¯æ´";
                lonElement.textContent = "ä¸æ”¯æ´";
            }
        }

        // --- åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ç›¸é—œå‡½æ•¸ ---
        function handleDeviceMotion(event) {
            const acceleration = event.accelerationIncludingGravity;
            
            if (acceleration) {
                accelXElement.textContent = acceleration.x.toFixed(2);
                accelYElement.textContent = acceleration.y.toFixed(2);
                accelZElement.textContent = acceleration.z.toFixed(2);
            }
        }

        function startDeviceMotion() {
            // æª¢æŸ¥æ˜¯å¦æ”¯æ´ DeviceMotionEvent
            if ('DeviceMotionEvent' in window) {
                motionStatusElement.textContent = "ğŸ‘ åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨æ”¯æ´ã€‚æ­£åœ¨ç›£è½æ•¸æ“š...";
                window.addEventListener('devicemotion', handleDeviceMotion);
                
                // é‡å° iOS 13+ çš„è™•ç†
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    motionStatusElement.textContent = "â— éœ€è¦é»æ“Šè¢å¹•é€²è¡Œæ„Ÿæ¸¬å™¨æˆæ¬Š (iOS 13+)ã€‚";
                    
                    document.body.addEventListener('click', () => {
                         DeviceMotionEvent.requestPermission().then(permissionState => {
                            if (permissionState === 'granted') {
                                motionStatusElement.textContent = "âœ… åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨å·²æˆæ¬Šä¸¦é–‹å§‹ç›£è½ã€‚";
                            } else {
                                motionStatusElement.textContent = "âŒ åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨æ¬Šé™è¢«æ‹’çµ•ã€‚";
                            }
                        }).catch(console.error);
                    }, { once: true });
                }

            } else {
                motionStatusElement.textContent = "ğŸ‘ ç€è¦½å™¨æˆ–è£ç½®ä¸æ”¯æ´åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨ã€‚";
            }
        }

        // --- é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ ---
        async function init() {
            // 1. åŸ·è¡Œæ‚¨è¦æ±‚çš„æ„Ÿæ¸¬å™¨æ¬Šé™æª¢æŸ¥
            await requestSensorPermissions(); 
            
            // 2. å•Ÿå‹•åœ°ç†ä½ç½®æœå‹™
            getGeolocation();
            
            // 3. å•Ÿå‹•åŠ é€Ÿåº¦æ„Ÿæ¸¬å™¨
            startDeviceMotion();
        }

        init();
    </script>
</body>
</html>