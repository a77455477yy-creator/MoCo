<!DOCTYPE html>

<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>行動通訊專題-延遲測試</title>
  
      <!-- 美化樣式由AI製作 -->
        <style>
        body { 

            background-color: #121212; 

            color: #ffffff; 

            font-family: "微軟正黑體", sans-serif; 

            padding: 20px; 

            text-align: center;

            max-width: 600px;

            margin: 0 auto;

        }

        

        .server-item { 

            background: #1e1e1e;

            border: 1px solid #333; 

            margin: 10px 0; 

            padding: 15px; 

            border-radius: 8px; 

            font-size: 16px;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .ping-result { color: #bb86fc; font-weight: bold; }




        .status-box {

            background-color: #2c2c2c;

            padding: 15px;

            border-radius: 8px;

            margin-bottom: 20px;

            text-align: left;

            font-size: 14px;

            border: 1px solid #444;

        }

        .status-box p { margin: 5px 0; }

        .highlight { color: #03dac6; font-weight: bold; }



        #locationNote {

            width: 100%;

            padding: 15px;

            font-size: 16px;

            margin-bottom: 15px;

            background-color: #1e1e1e;

            color: #fff;

            border: 1px solid #555;

            border-radius: 5px;

            box-sizing: border-box; 

        }

        #locationNote::placeholder { color: #888; }



        button { 

            width: 100%; 

            padding: 15px; 

            font-size: 18px; 

            background-color: #3700b3; 

            color: white; 

            border: none; 

            border-radius: 5px;

            margin-bottom: 20px;

            cursor: pointer;

            transition: background 0.3s;

        }

        button:hover { background-color: #5600e8; }

        button:disabled { background-color: #555; cursor: not-allowed; }



        #jsonBox {

            width: 100%; height: 200px; 

            background: #000; color: #00ff00;

            border: 1px solid #555; 

            font-family: monospace;

            text-align: left;

            padding: 10px;

            box-sizing: border-box; 

            overflow-y: scroll;

            font-size: 12px;

        }

    </style>

</head>

<body>



    <h2>延遲測試(PING值)</h2>

    

    <div class="status-box">
      
        <!-- id="..."是給JavaScript待抓到資料後，替換抓到的資料 -->
        <!-- 經緯度的id為gpsInfo，後面的流程會有搜尋id做替換的動作 -->
        <p>經緯度: <span id="gpsInfo" class="highlight">等待啟動...</span></p>
        <!-- API 地址的id為addressInfo，後面的流程會有搜尋id做替換的動作 -->
        <p>API 地址: <span id="addressInfo" class="highlight">等待查詢...</span></p>

    </div>



    <input type="text" id="locationNote" placeholder="輸入測試地點">


    <!-- 按下按鈕，會執行程式碼中，有關start()物件的功能，即程式的啟動開關 -->
    <button id="btnStart" onclick="app.start()">開始測試</button>



    <div id="list">

        <div class="server-item">台灣 (TW) <span id="res-tw" class="ping-result">-- ms</span></div>

        <div class="server-item">日本 (JP) <span id="res-jp" class="ping-result">-- ms</span></div>

        <div class="server-item">韓國 (KR) <span id="res-kr" class="ping-result">-- ms</span></div>

        <div class="server-item">新加坡 (SG) <span id="res-sg" class="ping-result">-- ms</span></div>

        <div class="server-item">美國 (US) <span id="res-us" class="ping-result">-- ms</span></div>

    </div>



    <h3>測試結果</h3>

    <div id="jsonBox">等待開始...</div>



    <script>
        // 啟動嚴格模式
        'use strict';


        // 定義app物件(records、servers、start: function、getGPS、getAddress、runTest、ping)
        const app = {
            // 儲存歷史紀錄的陣列
            records: [],
            // 測速的目標清單
            servers: [

                { id: 'tw', url: 'https://www.hinet.net' },

                { id: 'jp', url: 'https://hnd-jp-ping.vultr.com' },

                { id: 'kr', url: 'https://sel-kor-ping.vultr.com' },

                { id: 'sg', url: 'https://sgp-ping.vultr.com' },

                { id: 'us', url: 'https://lax-ca-us-ping.vultr.com' }

            ],


                // 啟動的總開關
                start: function() {

                // 按鈕鎖定功能，避免重複觸發，並將文字改顯示為正在定位...
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStart').innerText = "正在定位...";
                document.getElementById('gpsInfo').innerText = "定位中...";
                document.getElementById('addressInfo').innerText = "準備查詢...";



                // 啟動getGPS的功能，等getGPS程式碼的承諾完成後，然後將結果存進pos
                this.getGPS().then((pos) => {

                    // 拿到 GPS 後，再呼叫runTest開始跑測試流程，並且將pos的lat及lon傳遞到runTest的參數
                    this.runTest(pos.lat, pos.lon);

                });

            },



            // 核心功能: 抓取 GPS
            getGPS: function() {
                // 因抓GPS需要一些時間，先建立承諾(Promise)，讓程式繼續執行
                // 如果沒有先建立承諾，系統會直接抓空，要設定承諾的條件完成後，系統再抓座標才抓得出來
                return new Promise((resolve) => {
                    // 先檢查是否有支援定位功能
                    // 如果不存在navigator.geolocation則執行，會跳出不支援訊息並回報resolve為lat: 0, lon: 0後結束
                    if (!navigator.geolocation) {

                        alert("你的瀏覽器不支援定位");

                        resolve({ lat: 0, lon: 0 });
                        // 該return為停下所有動作
                        return;

                    }
                    // 呼叫手機GPS的指令
                    navigator.geolocation.getCurrentPosition(
                        // 當GPS抓取成功後自動生成position物件，內包含緯度(position.coords.latitude)、經度(position.coords.longitude)
                        (position) => {
                            // 將position物件內的lat存進lat(緯度)
                            let lat = position.coords.latitude; 
                            // 將position物件內的lon存進lon(經度)
                            let lon = position.coords.longitude;

                            

                            // 把抓到的數字，顯示在網頁上
                            // 把document的id=gpsInfo的字串，修改為緯度+經度(小數點後第5位)
                            document.getElementById('gpsInfo').innerText = lat.toFixed(5) + ", " + lon.toFixed(5);
                            // 承諾完成的信號，並將內部的lat及lon傳遞外部
                            resolve({ lat: lat, lon: lon });

                        },
                        // 當GPS抓取失敗的流程
                        (error) => {

                            console.error("GPS Error:", error);

                            document.getElementById('gpsInfo').innerText = "定位失敗";
                            // 抓取失敗，還是繼續跑，只是座標顯示0,0
                            resolve({ lat: 0, lon: 0 }); 

                        },
                        // 當GPS抓取資料超過5秒沒反應，進入失敗的流程
                        { timeout: 5000, enableHighAccuracy: true } 

                    );

                });

            },



            // 核心功能: 串接 OpenStreetMap API 查地址，將getGPS取得座標轉為地址
            // 使用async，因為需要等待OpenStreetMap 的伺服器回傳
            getAddress: async function(lat, lon) {
                // 前面的經緯度若被定義為0，則直接回傳無法定位，略過查詢
                if (lat === 0 && lon === 0) return "無法定位，略過查詢";


                // API的請求網址
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;

                

                try {
                    // 要求去指定之url抓取資料，且等待伺服器回應後存到response
                    const response = await fetch(url); 
                    // 讀取完整的response(JSON)內容，因為讀取並解析需要等待，使用await
                    const data = await response.json(); // 解析 JSON
                    // 解析JSON資料後，回傳地址字串給getAddress
                    return data.display_name; 

                } catch (error) {

                    console.error("API Error:", error);

                    return "API 查詢失敗 (可能是網路問題)";

                }

            },



            // 主要的流程，藉由傳遞的經緯度參數去跑
            runTest: async function(lat, lon) {

                // 將Id為btnStart的按鈕字串，修改為正在查詢地址 API...
                document.getElementById('btnStart').innerText = "正在查詢地址 API...";

                

                // 將getAddress回傳的地址字串，賦予addressResult
                let addressResult = await this.getAddress(lat, lon);

                

                // 將Id為addressInfo的字串，修改為addressResult(即地址字串)
                document.getElementById('addressInfo').innerText = addressResult;

                

                // 自動把地址填入備註欄 (如果沒填寫的話)

                let noteInput = document.getElementById('locationNote');

                if (noteInput.value.trim() === "") {

                    noteInput.value = addressResult; 

                }



                // 將Id為btnStart的按鈕字串，修改為測速中...
                document.getElementById('btnStart').innerText = "測速中...";

                let userNote = noteInput.value.trim();



                // 建立報告物件
                let report = {

                    time: new Date().toLocaleString(),

                    location: { lat: lat, lon: lon },

                    address_from_api: addressResult, 

                    user_note: userNote,

                    pings: {}

                };



                // 逐一測試伺服器
                for (let server of this.servers) {

                    document.getElementById('res-' + server.id).innerText = "...";

                    let ms = await this.ping(server.url);

                    document.getElementById('res-' + server.id).innerText = ms + " ms";

                    report.pings[server.id] = ms;

                }



                // 將建立的報告物件存為record，report變數會一直被覆蓋，存入陣列就可以保留了
                this.records.push(report);

                

                // 更新 JSON 顯示區
                document.getElementById('jsonBox').innerText = JSON.stringify(this.records, null, 2);



                document.getElementById('btnStart').disabled = false;

                document.getElementById('btnStart').innerText = "再次測試";

            },



            // 測速功能，計算從發出至收到回應經過多少毫秒
            ping: async function(url) {

                let startTime = Date.now();

                try {

                    await fetch(url + '?t=' + startTime, { 

                        mode: 'no-cors', 

                        cache: 'no-store' 

                    });

                    return Date.now() - startTime;

                } catch (error) {

                    return -1;

                }

            }

        };

    </script>

</body>

</html>
